name: "Dynamic Scan Action"
description: "Reusable action for validating credentials and running dynamic security scans."
author: "mfldosari"
inputs:
  # General inputs 
  # STARTING FROM HERE =>
  HOST:
    description: 'Host IP and Port'
    required: true 
  ACCESS_TOKEN:
    description: 'Access Token'
    required: true
  action_type:
    description: 'Action Type (scan_only or scan_and_exploit)'
    required: true
  mock_mode:
    description: 'Mock Mode (true or false)'
    required: true
    default: 'false'
  tracker_type:
    description: 'Issue Tracker Type (github or jira)'
    required: true
  server_url:
    description: 'Issue Tracker Server URL'
    required: true
  username:
    description: 'Issue Tracker Username'
    required: true
  password:
    description: 'Issue Tracker Password'
    required: true
  project_key:
    description: 'Issue Tracker Project Key'
    required: true
  scanner_name:
    description: 'Scanner Name'
    required: true
  git_url:
    description: 'Git URL'
    required: true
  git_branch:
    description: 'Git Branch'
    required: false
  git_credentials:
    description: 'Git Credentials'
    required: false
  git_username:
    description: 'Git Username'
    required: true
  git_password:
    description: 'Git Password'
    required: false
  # ENDING HERE
  
  # LLM specific inputs
  # STARTING FROM HERE =>
  llm_endpoint_url:
    description: 'LLM Endpoint URL'
    required: false

  llm_model_name:
    description: 'LLM Model Name'
    required: false
 
  llm_api_key:
    description: 'LLM API Key'
    required: false
  
  llm_max_context_tokens:
    description: 'LLM Max Context Tokens'
    required: false
  # ENDING HERE

  # If scan_and_exploit selected, these inputs are required
  # Exploiter specific inputs
  # STARTING FROM HERE =>
  exploiter_llm_api_key:
    description: 'Exploiter LLM API Key'
    required: true

  exploiter_llm_endpoint_url:
    description: 'Exploiter LLM Endpoint URL'
    required: true

  exploiter_llm_max_context_tokens:
    description: 'Exploiter LLM Max Context Tokens'
    required: true

  exploiter_llm_model_name:
    description: 'Exploiter LLM Model Name'
    required: true

  exploiter_target_url:
    description: 'Target URL for Exploitation'
    required: true

  exploiter_max_attempts:
    description: 'Max Attempts for Exploitation'
    required: true
  # ENDING HERE

runs:
  using: "composite"
  steps:
    - name: Check git_password or git_credentials provided
      shell: bash
      run: |
        if [ -z "${{ inputs.git_password }}" ] && [ -z "${{ inputs.git_credentials }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] You must provide at least one of 'git_password' or 'git_credentials'."
          exit 1
        fi
    - name: Check Required Inputs (scan_only)
      if: ${{ github.event.inputs.action_type == 'scan_only' || github.event.inputs.action_type == 'scan_and_exploit' }}
      shell: bash
      run: |
        missing=0
        if [ -z "${{ inputs.HOST }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'HOST' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.ACCESS_TOKEN }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'ACCESS_TOKEN' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.action_type }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'action_type' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.tracker_type }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'tracker_type' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.server_url }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'server_url' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.username }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'username' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.password }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'password' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.project_key }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'project_key' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.scanner_name }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'scanner_name' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.git_url }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'git_url' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.git_branch }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'git_branch' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.git_username }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'git_username' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.llm_endpoint_url }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'llm_endpoint_url' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.llm_model_name }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'llm_model_name' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.llm_api_key }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'llm_api_key' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.llm_max_context_tokens }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'llm_max_context_tokens' is required but not provided."
          missing=1
        fi
        if [ "$missing" -eq 1 ]; then
          exit 1
        fi
      
    - name: Check Required Inputs (scan_and_exploit)
      if: ${{ github.event.inputs.action_type == 'scan_and_exploit' }}
      shell: bash
      run: |
        missing=0
        # Check exploiter specific required inputs
        if [ -z "${{ inputs.exploiter_llm_api_key }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'exploiter_llm_api_key' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.exploiter_llm_endpoint_url }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'exploiter_llm_endpoint_url' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.exploiter_llm_max_context_tokens }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'exploiter_llm_max_context_tokens' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.exploiter_llm_model_name }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'exploiter_llm_model_name' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.exploiter_target_url }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'exploiter_target_url' is required but not provided."
          missing=1
        fi
        if [ -z "${{ inputs.exploiter_max_attempts }}" ]; then
          echo "::error::[SCAN TYPE: ${{ inputs.action_type }}] Input 'exploiter_max_attempts' is required but not provided."
          missing=1
        fi
        if [ "$missing" -eq 1 ]; then
          exit 1
        fi

    - name: Validate Issue Tracker Credentials
      shell: bash
      if: ${{ github.event.inputs.action_type == 'scan_only' || github.event.inputs.action_type == 'scan_and_exploit' }}
      run: |
        echo "Validating Issue Tracker Credentials..."
        if [[ "${{ inputs.tracker_type }}" == "github" ]]; then
          HTTP_CODE=$(curl -s -u "${{ inputs.username }}:${{ inputs.password }}" -o /dev/null -w "%{http_code}" "https://api.github.com/user")
          echo "GitHub API HTTP code: $HTTP_CODE"
          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "GitHub credentials valid."
          else
            echo "::error::GitHub credentials invalid. HTTP code: $HTTP_CODE"
            exit 1
          fi
        elif [[ "${{ inputs.tracker_type }}" == "jira" ]]; then
          curl -s -u "${{ inputs.username }}:${{ inputs.password }}" \
            -o /dev/null -w "%{http_code}" "${{ inputs.server_url }}/rest/api/2/myself" | grep -q "200"
          if [[ $? -eq 0 ]]; then
            echo "Jira credentials valid."
          else
            echo "::error::Jira credentials invalid."
            exit 1
          fi
        else
          echo "::error::Unknown tracker_type."
          exit 1
        fi
    - name: Validate SVC Credentials
      if: ${{ github.event.inputs.action_type == 'scan_only' || github.event.inputs.action_type == 'scan_and_exploit' }}
      shell: bash
      run: |
        echo "Validating SVC (Git) Credentials..."
        GIT_URL="${{ inputs.git_url }}"
        GIT_URL_NOPROTO=${GIT_URL#https://}
        git ls-remote --exit-code --heads "https://${{ inputs.git_username }}:${{ inputs.git_password }}@${GIT_URL_NOPROTO}" > /dev/null 2>&1
        if [[ $? -eq 0 ]]; then
          echo "SVC credentials valid."
        else
          echo "::error::SVC credentials invalid."
          exit 1
        fi
    - name: Execute Security Scan (Scan Only)
      shell: bash
      if: ${{ github.event.inputs.action_type == 'scan_only' }}
      run: |
        RESPONSE=$( curl -s -k -X POST \
          -H "Content-Type: application/json" \
          -H "accept: application/json" \
          -b "access_token=${{ inputs.ACCESS_TOKEN }}" \
          "http://${{ inputs.HOST }}/api/v1/orchestrator/execute" \
          --data-binary @- <<EOF
        {
          "action_type": "${{ inputs.action_type }}",
          "mock_mode": ${{ inputs.mock_mode }},
          "issue_tracker": {
              "tracker_type": "${{ inputs.tracker_type }}",
              "server_url": "${{ inputs.server_url }}",
              "username": "${{ inputs.username }}",
              "password": "${{ inputs.password }}",
              "project_key": "${{ inputs.project_key }}"
          },
          "scanner": {
              "name": "${{ inputs.scanner_name }}",
              "git_url": "${{ inputs.git_url }}",
              "git_branch": "${{ inputs.git_branch }}",
              "git_credentials": "${{ inputs.git_credentials }}",
              "git_username": "${{ inputs.git_username }}",
              "git_password": "${{ inputs.git_password }}",
              "llm_endpoint_url": "http://172.20.30.92:11434/v1",
              "llm_model_name": "SimonPu/qwen3-coder:30B-Instruct_Q4_K_XL",
              "llm_api_key": "ollama",
              "llm_max_context_tokens": 262144,
              "include_file_extensions": [".java",".jsp",".js",".py"],
              "exclude_file_dirs": [".git", "node_modules", "venv", "__pycache__", "docs", "target"],
              "include_vulnerability_types": ["SQL Injection", "Cross-Site Scripting (XSS)", "Insecure Authentication"],
              "max_vulnerabilities": 10
          }
        }
        EOF
        )
        echo "RESPONSE=$RESPONSE"
        ID=$(echo "$RESPONSE" | jq -r '.scan_id')
        echo "ID=$ID"
        echo "$ID" > scan_id.txt

    - name: Execute Security Scan (Scan and Exploit)
      shell: bash
      if: ${{ github.event.inputs.action_type == 'scan_and_exploit' }}
      run: |
        RESPONSE=$( curl -s -k -X POST \
          -H "Content-Type: application/json" \
          -H "accept: application/json" \
          -b "access_token=${{ inputs.ACCESS_TOKEN }}" \
          "http://${{ inputs.HOST }}/api/v1/orchestrator/execute" \
          --data-binary @- <<EOF
        {
          "action_type": "${{ inputs.action_type }}",
          "mock_mode": ${{ inputs.mock_mode }},
          "issue_tracker": {
              "tracker_type": "${{ inputs.tracker_type }}",
              "server_url": "${{ inputs.server_url }}",
              "username": "${{ inputs.username }}",
              "password": "${{ inputs.password }}",
              "project_key": "${{ inputs.project_key }}"
          },
          "scanner": {
              "name": "${{ inputs.scanner_name }}",
              "git_url": "${{ inputs.git_url }}",
              "git_branch": "${{ inputs.git_branch }}",
              "git_credentials": "${{ inputs.git_credentials }}",
              "git_username": "${{ inputs.git_username }}",
              "git_password": "${{ inputs.git_password }}",
              "llm_endpoint_url": "${{ inputs.llm_endpoint_url }}",
              "llm_model_name": "${{ inputs.llm_model_name }}",
              "llm_api_key": "${{ inputs.llm_api_key }}",
              "llm_max_context_tokens": ${{ inputs.llm_max_context_tokens }},
              "include_file_extensions": [".java",".jsp",".js",".py"],
              "exclude_file_dirs": [".git", "node_modules", "venv", "__pycache__", "docs", "target"],
              "include_vulnerability_types": ["SQL Injection", "Cross-Site Scripting (XSS)", "Insecure Authentication"],
              "max_vulnerabilities": 10
          },
          "exploiter": {
              "exploiter_llm_api_key": "${{ inputs.exploiter_llm_api_key }}",
              "exploiter_llm_endpoint_url": "${{ inputs.exploiter_llm_endpoint_url }}",
              "exploiter_llm_max_context_tokens": ${{ inputs.exploiter_llm_max_context_tokens }},
              "exploiter_llm_model_name": "${{ inputs.exploiter_llm_model_name }}",
              "max_attempts": ${{ inputs.exploiter_max_attempts }},
              "target_url": "${{ inputs.exploiter_target_url }}"
          }
        }
        EOF
        )
        echo "RESPONSE=$RESPONSE"
        ID=$(echo "$RESPONSE" | jq -r '.scan_id')
        echo "ID=$ID"
        echo "$ID" > scan_id.txt

    - name: Scan Validation & Check Security Thresholds
      if: ${{ github.event.inputs.action_type == 'scan_only' || github.event.inputs.action_type == 'scan_and_exploit' }}
      id: scan_validation
      shell: bash
      run: |
        # Read scan_id from file
        SCAN_ID=$(cat scan_id.txt)
        if [ -z "$SCAN_ID" ] || [ "$SCAN_ID" = "null" ]; then
          echo "::error::No scan_id found. Cannot validate scan."
          exit 1
        fi
        URL="http://${{ inputs.HOST }}/api/v1/scans/$SCAN_ID"
        echo "Starting polling for Scan ID: $SCAN_ID"
        while true; do
          RESPONSE=$(curl -s -X 'GET' "$URL" -H 'accept: application/json')
          CURRENT_STATUS=$(echo "$RESPONSE" | jq -r '.status')
          echo "Current Status: $CURRENT_STATUS"
          if [[ "$CURRENT_STATUS" == "completed" || "$CURRENT_STATUS" == "failed" ]]; then
            break
          fi
          echo "Still running... sleeping 2 minutes."
          sleep 120
        done
        if [[ "$CURRENT_STATUS" == "failed" ]]; then
          echo "::error::Scan system failure."
          exit 1
        fi
        RESULT=$(curl -s -X 'GET' "$URL" -H 'accept: application/json')
        TOTAL=$(echo "$RESULT" | jq -r '.total_vulnerabilities_found // 0')
        CRITICAL=$(echo "$RESULT" | jq -r '.critical_count // 0')
        HIGH=$(echo "$RESULT" | jq -r '.high_count // 0')
        MEDIUM=$(echo "$RESULT" | jq -r '.medium_count // 0')
        LOW=$(echo "$RESULT" | jq -r '.low_count // 0')
        # Store analysis summary in JSON
        ANALYSIS_JSON=$(jq -n \
          --arg total "$TOTAL" \
          --arg critical "$CRITICAL" \
          --arg high "$HIGH" \
          --arg medium "$MEDIUM" \
          --arg low "$LOW" \
          --arg completed_at "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
          '{total: $total, critical: $critical, high: $high, medium: $medium, low: $low, completed_at: $completed_at}')
        echo "$ANALYSIS_JSON" > analysis_summary.json
        echo "Analysis summary saved to analysis_summary.json: $ANALYSIS_JSON"
        SCAN_COMPLETED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        echo "Scan completed at: $SCAN_COMPLETED_AT"
        if [ "$TOTAL" -eq 0 ]; then
          echo "No vulnerabilities found. Deployment allowed."
        elif [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ] || [ "$MEDIUM" -gt 0 ]; then
          echo "::error::Security gate failed. Found $CRITICAL Critical, $HIGH High, $MEDIUM Medium."
        else
          echo "Only low-level issues found. Proceeding."
        fi
      
